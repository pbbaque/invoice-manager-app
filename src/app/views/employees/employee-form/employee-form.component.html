<div class="page">
  <app-alert
    [message]="errorMessage"
    type="error"
    [visible]="errorVisible"
    (closed)="errorVisible = false"
  >
  </app-alert>

  <div class="page__header">
    <h2 class="page__name">
      {{ isEditMode ? "Editar Empleado" : "Nuevo Empleado" }}
    </h2>
    <p class="page__description">
      {{
        isEditMode
          ? "Aquí puedes modificar los datos del empleado."
          : "Aquí puedes registrar un nuevo empleado en el sistema."
      }}
    </p>
  </div>

  <div class="page__content">
    <form class="form" [formGroup]="employeeForm" (ngSubmit)="onSubmit()">
      <div class="form__content">

        <div class="form__group--row">
          <div class="form__field">
            <label for="name" class="form__label">Nombre</label>
            <input type="text" class="form__input" id="name" placeholder="Tu Nombre" formControlName="name" />
            <small class="form__error" *ngIf="name?.touched && name?.invalid">
              <span *ngIf="name?.errors?.['required']">El nombre es obligatorio</span>
              <span *ngIf="name?.errors?.['name']">Formato de nombre inválido</span>
            </small>
          </div>
          <div class="form__field">
            <label for="lastname" class="form__label">Apellido</label>
            <input type="text" class="form__input" id="lastname" placeholder="Tu Apellido" formControlName="lastname" />
            <small class="form__error" *ngIf="lastname?.touched && lastname?.invalid">
              <span *ngIf="lastname?.errors?.['required']">El apellido es obligatorio</span>
              <span *ngIf="lastname?.errors?.['lastname']">Formato de apellido inválido</span>
            </small>
          </div>
        </div>

        <div class="form__group--row">
          <div class="form__field">
            <label for="email" class="form__label">Email</label>
            <input type="email" class="form__input" id="email" placeholder="Tu Email" formControlName="email" />
            <small class="form__error" *ngIf="email?.touched && email?.invalid">
              <span *ngIf="email?.errors?.['required']">El email es obligatorio</span>
              <span *ngIf="email?.errors?.['email']">Formato de email inválido</span>
            </small>
          </div>
          <div class="form__field">
            <label for="phone" class="form__label">Telefono</label>
            <input type="number" class="form__input" id="phone" placeholder="Tu Telefono" formControlName="phone" />
            <small class="form__error" *ngIf="phone?.touched && phone?.invalid">
              <span *ngIf="phone?.errors?.['required']">El telefono es obligatorio</span>
              <span *ngIf="phone?.errors?.['phone']">Formato de telefono inválido</span>
            </small>
          </div>
        </div>

        <div class="form__group--row">
          <div class="form__field">
            <label for="position" class="form__label">Posición</label>
            <input type="text" class="form__input" id="position" placeholder="Puesto de trabajo" formControlName="position" />
            <small class="form__error" *ngIf="position?.touched && position?.invalid">
              <span *ngIf="position?.errors?.['required']">La posición es obligatoria</span>
              <span *ngIf="position?.errors?.['position']">Formato de posición inválido</span>
            </small>
          </div>
          <div class="form__field">
            <label for="salary" class="form__label">Salario</label>
            <input type="text" class="form__input" id="salary" placeholder="Salario" formControlName="salary" />
            <small class="form__error" *ngIf="salary?.touched && salary?.invalid">
              <span *ngIf="salary?.errors?.['required']">El salario es obligatorio</span>
              <span *ngIf="salary?.errors?.['salary']">Formato de salario inválido</span>
            </small>
          </div>
        </div>

        <div class="form__group--row form-radio-group">
          <div class="form__field">
            <label>
              <input type="radio" name="userOption" value="existing" [(ngModel)]="userOption" [ngModelOptions]="{ standalone: true }" />
              Asignar usuario existente
            </label>
          </div>
          <div class="form__field">
            <label>
              <input type="radio" name="userOption" value="new" [(ngModel)]="userOption" [ngModelOptions]="{ standalone: true }" />
              Crear usuario nuevo
            </label>
          </div>
        </div>

        <div formGroupName="user" *ngIf="userOption === 'new'">
          <div class="form__group--row">
            <div class="form__field">
              <label for="username" class="form__label">Usuario</label>
              <input type="text" class="form__input" id="username" placeholder="Nombre de usuario" formControlName="username" />
              <small class="form__error" *ngIf="user?.get('username')?.touched && user?.get('username')?.invalid">
                <span *ngIf="user?.get('username')?.errors?.['required']">El usuario es obligatorio</span>
              </small>
            </div>
            <div class="form__field">
              <label for="userEmail" class="form__label">Email</label>
              <input type="email" class="form__input" id="userEmail" placeholder="Email" formControlName="email" />
              <small class="form__error" *ngIf="user?.get('email')?.touched && user?.get('email')?.invalid">
                <span *ngIf="user?.get('email')?.errors?.['required']">El email es obligatorio</span>
                <span *ngIf="user?.get('email')?.errors?.['email']">Formato de email inválido</span>
              </small>
            </div>
          </div>

          <div class="form__group--row" *ngIf="!isEditMode">
            <div class="form__field">
              <label for="password" class="form__label">Contraseña</label>
              <input type="password" class="form__input" id="password" placeholder="Contraseña" formControlName="password" />
              <small class="form__error" *ngIf="user?.get('password')?.touched && user?.get('password')?.invalid">
                <span *ngIf="user?.get('password')?.errors?.['required']">La contraseña es obligatoria</span>
              </small>
            </div>
            <div class="form__field">
              <label for="repeat" class="form__label">Repite la contraseña</label>
              <input type="password" class="form__input" id="repeat" placeholder="Repite la contraseña" formControlName="repeat" />
            </div>
          </div>
        </div>

         <div class="form__group--row" *ngIf="userOption === 'existing'">
           <div class="form__field">
             <label for="existingUser" class="form__label">Usuario existente</label>
             <input type="text" class="form__input" id="existingUser" placeholder="Buscar usuario..." [(ngModel)]="existingUserTerm" (ngModelChange)="searchUsers()" [ngModelOptions]="{standalone:true}" />
             <ul *ngIf="filteredUsers.length">
               <li *ngFor="let u of filteredUsers" (click)="selectUser(u)">{{ u.username }} ({{ u.email }})</li>
             </ul>
           </div>
         </div>

        <div class="form__group--row">
          <div *ngIf="isAdmin" class="form__field" formGroupName="company">
            <label for="companyId" class="form__label">Compañía</label>
            <select id="companyId" class="form__input" formControlName="id">
              <option value="null" disabled>Seleccione una compañía</option>
              <option *ngFor="let company of companies" [value]="company.id">{{ company.name }}</option>
            </select>
            <small *ngIf="company?.get('id')?.touched && company?.get('id')?.invalid" class="form__error">
              <span *ngIf="company?.get('id')?.errors?.['required']">La compañía es obligatoria</span>
            </small>
          </div>
        </div>
      </div>

      <div class="form__group--row">
        <input type="submit" class="form__submit" [value]="isEditMode ? 'Guardar Cambios' : 'Registrar Empleado'" />
        <input type="button" class="form__return" value="Volver" (click)="goBack()" />
      </div>
    </form>
  </div>
</div>
